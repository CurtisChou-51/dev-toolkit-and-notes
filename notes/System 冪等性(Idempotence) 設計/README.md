# System 冪等性(Idempotence) 設計

- System 冪等性(Idempotence) 設計筆記

## 基本概念

- 在資訊系統中**冪等性**指同一操作執行一次或多次，對系統狀態的影響相同

- 對於API設計：
  - Client 可以安全重試請求
  - 網路不穩定不會導致重複副作用
  - Server 狀態保持一致性

- 對於ETL執行：
  - 相同ETL重複執行結果會一致
  - 通常也會考慮在不同時間執行相同資料日期的ETL也要得到相同結果
  
## 常見場景

- 訂單系統：提交訂單後網路延遲未收到回應，使用者重複提交
- 庫存系統：多個請求同時扣除庫存

  
## 實現方案

| 方案                | 機制                                                                 | 特性                                                                 |
|-------------------------|--------------------------------------------------------------------------|---------------------------------------|
| **1. Server生成Token**  | - Server提供派發唯一Token接口<br>- Client攜帶Token執行操作<br>- Server驗證Token狀態 | - 強一致性<br>- 可精細控制Token<br>- 預請求開銷                         |
| **2. 資料唯一性判斷**   | - 從請求參數提取唯一識別<br>- 通過業務規則驗證（如：主鍵、特定欄位Hash）       | - 無狀態設計<br>- 無需預請求<br>- 依賴於參數特性                           |
| **3. Client生成Token**  | - Client自行構造冪等性Key<br>- 使用保證唯一性算法（如：UUID）     | - 減少Server壓力<br>- 單次請求完成<br>- Client需保證邏輯可靠性              |


## Server 端冪等性處理方案

- 資料庫 Unique Key 限制
- 資料庫樂觀鎖
- 業務邏輯狀態檢查控制
- Server 端暫存層控制，如 Redis